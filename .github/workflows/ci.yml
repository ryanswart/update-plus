name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  test-path-replacement:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        test_scenario:
          - root_to_runner
          - home_exedev_to_runner
          - multiple_paths
          - yaml_files
          - shell_scripts
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup test environment
        run: |
          sudo apt-get update
          sudo apt-get install -y jq rsync
          mkdir -p ~/.openclaw/backups

      - name: Test ${{ matrix.test_scenario }}
        run: |
          export HOME="$HOME"
          export BACKUP_DIR="$HOME/.openclaw/backups"
          mkdir -p "$BACKUP_DIR"
          
          case "${{ matrix.test_scenario }}" in
            root_to_runner)
              echo "=== Testing /root to \$HOME replacement ==="
              TMP_DIR=$(mktemp -d)
              mkdir -p "$TMP_DIR/config"
              echo '{"workspace": "/root/.openclaw/workspace", "config": "/root/.openclaw/config"}' > "$TMP_DIR/config/openclaw.json"
              tar -czf "$BACKUP_DIR/test-root.tar.gz" -C "$TMP_DIR" config
              rm -rf "$TMP_DIR"
              
              bash -c 'source bin/lib/utils.sh; source bin/lib/config.sh; source bin/lib/restore.sh; load_config; set -euo pipefail; restore_backup "test-root.tar.gz" "" "--force"'
              
              if grep -q "/root/" "$HOME/.openclaw/openclaw.json"; then
                echo "❌ /root paths not replaced"
                cat "$HOME/.openclaw/openclaw.json"
                exit 1
              fi
              if ! grep -q "$HOME/.openclaw/workspace" "$HOME/.openclaw/openclaw.json"; then
                echo "❌ HOME path not found"
                cat "$HOME/.openclaw/openclaw.json"
                exit 1
              fi
              echo "✅ /root to \$HOME replacement test passed"
              ;;
              
            home_exedev_to_runner)
              echo "=== Testing /home/exedev to \$HOME replacement ==="
              TMP_DIR=$(mktemp -d)
              mkdir -p "$TMP_DIR/config" "$TMP_DIR/workspace"
              echo '{"path": "/home/exedev/.openclaw/test"}' > "$TMP_DIR/config/paths.json"
              echo '/home/exedev/.openclaw/workspace' > "$TMP_DIR/workspace/location.txt"
              tar -czf "$BACKUP_DIR/test-exedev.tar.gz" -C "$TMP_DIR" config workspace
              rm -rf "$TMP_DIR"
              
              bash -c 'source bin/lib/utils.sh; source bin/lib/config.sh; source bin/lib/restore.sh; load_config; set -euo pipefail; restore_backup "test-exedev.tar.gz" "" "--force"'
              
              if grep -q "/home/exedev" "$HOME/.openclaw/paths.json"; then
                echo "❌ /home/exedev paths not replaced in JSON"
                cat "$HOME/.openclaw/paths.json"
                exit 1
              fi
              if grep -q "/home/exedev" "$HOME/.openclaw/workspace/location.txt"; then
                echo "❌ /home/exedev paths not replaced in text file"
                cat "$HOME/.openclaw/workspace/location.txt"
                exit 1
              fi
              echo "✅ /home/exedev to \$HOME replacement test passed"
              ;;
              
            multiple_paths)
              echo "=== Testing multiple different home paths ==="
              TMP_DIR=$(mktemp -d)
              mkdir -p "$TMP_DIR/config"
              # Simulate backup with multiple different home directories
              cat > "$TMP_DIR/config/multi.json" << 'EOF'
          {
            "users": [
              {"home": "/home/user1/.openclaw", "name": "user1"},
              {"home": "/home/user2/.openclaw", "name": "user2"},
              {"home": "/root/.openclaw", "name": "root"}
            ]
          }
          EOF
              tar -czf "$BACKUP_DIR/test-multi.tar.gz" -C "$TMP_DIR" config
              rm -rf "$TMP_DIR"
              
              bash -c 'source bin/lib/utils.sh; source bin/lib/config.sh; source bin/lib/restore.sh; load_config; set -euo pipefail; restore_backup "test-multi.tar.gz" "" "--force"'
              
              # Check that all old paths are gone
              if grep -E "/home/user[12]/|/root/" "$HOME/.openclaw/multi.json" > /dev/null 2>&1; then
                echo "❌ Some old paths remain"
                cat "$HOME/.openclaw/multi.json"
                exit 1
              fi
              # Check that new paths are present
              if ! grep -q "$HOME/.openclaw" "$HOME/.openclaw/multi.json"; then
                echo "❌ New HOME paths not found"
                cat "$HOME/.openclaw/multi.json"
                exit 1
              fi
              echo "✅ Multiple paths replacement test passed"
              ;;
              
            yaml_files)
              echo "=== Testing YAML file path replacement ==="
              TMP_DIR=$(mktemp -d)
              mkdir -p "$TMP_DIR/config"
              cat > "$TMP_DIR/config/settings.yaml" << 'EOF'
          workspace: /root/.openclaw/workspace
          config_dir: /root/.openclaw/config
          log_path: /root/.openclaw/logs
          EOF
              tar -czf "$BACKUP_DIR/test-yaml.tar.gz" -C "$TMP_DIR" config
              rm -rf "$TMP_DIR"
              
              bash -c 'source bin/lib/utils.sh; source bin/lib/config.sh; source bin/lib/restore.sh; load_config; set -euo pipefail; restore_backup "test-yaml.tar.gz" "" "--force"'
              
              if grep -q "/root/" "$HOME/.openclaw/settings.yaml"; then
                echo "❌ /root paths not replaced in YAML"
                cat "$HOME/.openclaw/settings.yaml"
                exit 1
              fi
              if ! grep -q "$HOME/.openclaw/workspace" "$HOME/.openclaw/settings.yaml"; then
                echo "❌ HOME path not found in YAML"
                cat "$HOME/.openclaw/settings.yaml"
                exit 1
              fi
              echo "✅ YAML file path replacement test passed"
              ;;
              
            shell_scripts)
              echo "=== Testing shell script path replacement ==="
              TMP_DIR=$(mktemp -d)
              mkdir -p "$TMP_DIR/scripts"
              cat > "$TMP_DIR/scripts/setup.sh" << 'EOF'
          #!/bin/bash
          WORKSPACE="/home/developer/.openclaw/workspace"
          CONFIG="/home/developer/.openclaw/config"
          echo "Setting up in $WORKSPACE"
          EOF
              chmod +x "$TMP_DIR/scripts/setup.sh"
              tar -czf "$BACKUP_DIR/test-script.tar.gz" -C "$TMP_DIR" scripts
              rm -rf "$TMP_DIR"
              
              bash -c 'source bin/lib/utils.sh; source bin/lib/config.sh; source bin/lib/restore.sh; load_config; set -euo pipefail; restore_backup "test-script.tar.gz" "" "--force"'
              
              if grep -q "/home/developer/" "$HOME/.openclaw/scripts/setup.sh"; then
                echo "❌ /home/developer paths not replaced in script"
                cat "$HOME/.openclaw/scripts/setup.sh"
                exit 1
              fi
              if ! grep -q "$HOME/.openclaw/workspace" "$HOME/.openclaw/scripts/setup.sh"; then
                echo "❌ HOME path not found in script"
                cat "$HOME/.openclaw/scripts/setup.sh"
                exit 1
              fi
              echo "✅ Shell script path replacement test passed"
              ;;
          esac

  test-restore:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        test_case:
          - labeled_backup
          - legacy_backup
          - force_flag
          - path_replacement
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup test environment
        run: |
          sudo apt-get update
          sudo apt-get install -y jq rsync
          mkdir -p ~/.openclaw

      - name: Test ${{ matrix.test_case }}
        run: |
          export HOME="$HOME"
          export BACKUP_DIR="$HOME/.openclaw/backups"
          mkdir -p "$BACKUP_DIR"
          
          case "${{ matrix.test_case }}" in
            labeled_backup)
              echo "=== Testing labeled backup restore ==="
              # Create test backup with labels
              TMP_DIR=$(mktemp -d)
              mkdir -p "$TMP_DIR/config" "$TMP_DIR/skills" "$TMP_DIR/workspace"
              echo '{"version": 1}' > "$TMP_DIR/config/test.json"
              echo 'skill content' > "$TMP_DIR/skills/test-skill.txt"
              echo 'workspace content' > "$TMP_DIR/workspace/README.md"
              tar -czf "$BACKUP_DIR/test-labeled.tar.gz" -C "$TMP_DIR" config skills workspace
              rm -rf "$TMP_DIR"
              
              # Test restore - call load_config to initialize variables
              bash -c 'source bin/lib/utils.sh; source bin/lib/config.sh; source bin/lib/restore.sh; load_config; set -euo pipefail; restore_backup "test-labeled.tar.gz" "" "--force"'
              
              # Verify
              [ -f "$HOME/.openclaw/test.json" ] || { echo "Config not restored"; exit 1; }
              [ -f "$HOME/.openclaw/skills/test-skill.txt" ] || { echo "Skills not restored"; exit 1; }
              [ -f "$HOME/.openclaw/workspace/README.md" ] || { echo "Workspace not restored"; exit 1; }
              echo "✅ Labeled backup test passed"
              ;;
              
            legacy_backup)
              echo "=== Testing legacy backup restore ==="
              # Create legacy backup (flat structure)
              TMP_DIR=$(mktemp -d)
              echo 'legacy content' > "$TMP_DIR/legacy.txt"
              tar -czf "$BACKUP_DIR/test-legacy.tar.gz" -C "$TMP_DIR" .
              rm -rf "$TMP_DIR"
              
              # Test restore - call load_config to initialize variables
              bash -c 'source bin/lib/utils.sh; source bin/lib/config.sh; source bin/lib/restore.sh; load_config; set -euo pipefail; restore_backup "test-legacy.tar.gz" "" "--force"'
              
              echo "✅ Legacy backup test passed"
              ;;
              
            force_flag)
              echo "=== Testing --force flag (no prompt) ==="
              # Create test backup
              TMP_DIR=$(mktemp -d)
              mkdir -p "$TMP_DIR/config"
              echo '{}' > "$TMP_DIR/config/test.json"
              tar -czf "$BACKUP_DIR/test-force.tar.gz" -C "$TMP_DIR" config
              rm -rf "$TMP_DIR"
              
              # Test restore with --force - should NOT prompt - call load_config
              timeout 5 bash -c 'source bin/lib/utils.sh; source bin/lib/config.sh; source bin/lib/restore.sh; load_config; set -euo pipefail; restore_backup "test-force.tar.gz" "" "--force"' || { echo "Restore with --force failed or timed out"; exit 1; }
              
              echo "✅ Force flag test passed"
              ;;
              
            path_replacement)
              echo "=== Testing path replacement ==="
              # Create backup with hardcoded /root paths
              TMP_DIR=$(mktemp -d)
              mkdir -p "$TMP_DIR/config"
              echo '{"path": "/root/.openclaw/test"}' > "$TMP_DIR/config/paths.json"
              tar -czf "$BACKUP_DIR/test-paths.tar.gz" -C "$TMP_DIR" config
              rm -rf "$TMP_DIR"
              
              # Test restore - call load_config
              bash -c 'source bin/lib/utils.sh; source bin/lib/config.sh; source bin/lib/restore.sh; load_config; set -euo pipefail; restore_backup "test-paths.tar.gz" "" "--force"'
              
              # Verify path was replaced
              if grep -q "$HOME/.openclaw/test" "$HOME/.openclaw/paths.json"; then
                echo "✅ Path replacement test passed"
              else
                echo "Path not replaced correctly"
                cat "$HOME/.openclaw/paths.json"
                exit 1
              fi
              ;;
          esac

  test-backup:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup test environment
        run: |
          sudo apt-get update
          sudo apt-get install -y jq rsync
          mkdir -p ~/.openclaw/{workspace,skills,backups}
          echo '{"backup_paths": [{"path": "~/.openclaw/config", "label": "config"}, {"path": "~/.openclaw/workspace", "label": "workspace"}]}' > ~/.openclaw/update-plus.json

      - name: Test backup creation
        run: |
          # Create test files
          mkdir -p ~/.openclaw/config
          echo '{"test": true}' > ~/.openclaw/config/test.json
          echo 'workspace content' > ~/.openclaw/workspace/README.md
          
          # Test backup - call load_config to initialize variables
          bash -c 'source bin/lib/utils.sh; source bin/lib/config.sh; source bin/lib/backup.sh; load_config; set -euo pipefail; create_backup'
          
          # Verify backup exists
          ls -la ~/.openclaw/backups/*.tar.gz || { echo "Backup not created"; exit 1; }
          
          echo "✅ Backup creation test passed"

  test-unbound-variable:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup test environment
        run: |
          sudo apt-get update
          sudo apt-get install -y jq rsync
          mkdir -p ~/.openclaw/backups

      - name: Test unbound variable fix
        run: |
          # Create backup with unknown labels to trigger unbound variable issue
          TMP_DIR=$(mktemp -d)
          mkdir -p "$TMP_DIR/config" "$TMP_DIR/skills" "$TMP_DIR/extensions"
          echo '{}' > "$TMP_DIR/config/test.json"
          tar -czf "$HOME/.openclaw/backups/test-unbound.tar.gz" -C "$TMP_DIR" config skills extensions
          rm -rf "$TMP_DIR"
          
          # This should NOT fail with "unbound variable" error - call load_config
          bash -c 'source bin/lib/utils.sh; source bin/lib/config.sh; source bin/lib/restore.sh; load_config; set -euo pipefail; restore_backup "test-unbound.tar.gz" "" "--force"' || { echo "Unbound variable test failed"; exit 1; }
          
          echo "✅ Unbound variable test passed"

  shellcheck:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run shellcheck
        uses: ludeeus/action-shellcheck@master
        with:
          severity: error
          scandir: './bin'
