name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  test-restore:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        test_case:
          - labeled_backup
          - legacy_backup
          - force_flag
          - path_replacement
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup test environment
        run: |
          sudo apt-get update
          sudo apt-get install -y jq rsync
          mkdir -p ~/.openclaw

      - name: Test ${{ matrix.test_case }}
        run: |
          export HOME="$HOME"
          export BACKUP_DIR="$HOME/.openclaw/backups"
          mkdir -p "$BACKUP_DIR"
          
          case "${{ matrix.test_case }}" in
            labeled_backup)
              echo "=== Testing labeled backup restore ==="
              # Create test backup with labels
              TMP_DIR=$(mktemp -d)
              mkdir -p "$TMP_DIR/config" "$TMP_DIR/skills" "$TMP_DIR/workspace"
              echo '{"version": 1}' > "$TMP_DIR/config/test.json"
              echo 'skill content' > "$TMP_DIR/skills/test-skill.txt"
              echo 'workspace content' > "$TMP_DIR/workspace/README.md"
              tar -czf "$BACKUP_DIR/test-labeled.tar.gz" -C "$TMP_DIR" config skills workspace
              rm -rf "$TMP_DIR"
              
              # Test restore - call load_config to initialize variables
              bash -c 'source bin/lib/utils.sh; source bin/lib/config.sh; source bin/lib/restore.sh; load_config; set -euo pipefail; restore_backup "test-labeled.tar.gz" "" "--force"'
              
              # Verify
              [ -f "$HOME/.openclaw/test.json" ] || { echo "Config not restored"; exit 1; }
              [ -f "$HOME/.openclaw/skills/test-skill.txt" ] || { echo "Skills not restored"; exit 1; }
              [ -f "$HOME/.openclaw/workspace/README.md" ] || { echo "Workspace not restored"; exit 1; }
              echo "✅ Labeled backup test passed"
              ;;
              
            legacy_backup)
              echo "=== Testing legacy backup restore ==="
              # Create legacy backup (flat structure)
              TMP_DIR=$(mktemp -d)
              echo 'legacy content' > "$TMP_DIR/legacy.txt"
              tar -czf "$BACKUP_DIR/test-legacy.tar.gz" -C "$TMP_DIR" .
              rm -rf "$TMP_DIR"
              
              # Test restore - call load_config to initialize variables
              bash -c 'source bin/lib/utils.sh; source bin/lib/config.sh; source bin/lib/restore.sh; load_config; set -euo pipefail; restore_backup "test-legacy.tar.gz" "" "--force"'
              
              echo "✅ Legacy backup test passed"
              ;;
              
            force_flag)
              echo "=== Testing --force flag (no prompt) ==="
              # Create test backup
              TMP_DIR=$(mktemp -d)
              mkdir -p "$TMP_DIR/config"
              echo '{}' > "$TMP_DIR/config/test.json"
              tar -czf "$BACKUP_DIR/test-force.tar.gz" -C "$TMP_DIR" config
              rm -rf "$TMP_DIR"
              
              # Test restore with --force - should NOT prompt - call load_config
              timeout 5 bash -c 'source bin/lib/utils.sh; source bin/lib/config.sh; source bin/lib/restore.sh; load_config; set -euo pipefail; restore_backup "test-force.tar.gz" "" "--force"' || { echo "Restore with --force failed or timed out"; exit 1; }
              
              echo "✅ Force flag test passed"
              ;;
              
            path_replacement)
              echo "=== Testing path replacement ==="
              # Create backup with hardcoded /root paths
              TMP_DIR=$(mktemp -d)
              mkdir -p "$TMP_DIR/config"
              echo '{"path": "/root/.openclaw/test"}' > "$TMP_DIR/config/paths.json"
              tar -czf "$BACKUP_DIR/test-paths.tar.gz" -C "$TMP_DIR" config
              rm -rf "$TMP_DIR"
              
              # Test restore - call load_config
              bash -c 'source bin/lib/utils.sh; source bin/lib/config.sh; source bin/lib/restore.sh; load_config; set -euo pipefail; restore_backup "test-paths.tar.gz" "" "--force"'
              
              # Verify path was replaced
              if grep -q "$HOME/.openclaw/test" "$HOME/.openclaw/paths.json"; then
                echo "✅ Path replacement test passed"
              else
                echo "Path not replaced correctly"
                cat "$HOME/.openclaw/paths.json"
                exit 1
              fi
              ;;
          esac

  test-backup:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup test environment
        run: |
          sudo apt-get update
          sudo apt-get install -y jq rsync
          mkdir -p ~/.openclaw/{workspace,skills,backups}
          echo '{"backup_paths": [{"path": "~/.openclaw/config", "label": "config"}, {"path": "~/.openclaw/workspace", "label": "workspace"}]}' > ~/.openclaw/update-plus.json

      - name: Test backup creation
        run: |
          # Create test files
          mkdir -p ~/.openclaw/config
          echo '{"test": true}' > ~/.openclaw/config/test.json
          echo 'workspace content' > ~/.openclaw/workspace/README.md
          
          # Test backup - call load_config to initialize variables
          bash -c 'source bin/lib/utils.sh; source bin/lib/config.sh; source bin/lib/backup.sh; load_config; set -euo pipefail; create_backup'
          
          # Verify backup exists
          ls -la ~/.openclaw/backups/*.tar.gz || { echo "Backup not created"; exit 1; }
          
          echo "✅ Backup creation test passed"

  test-unbound-variable:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup test environment
        run: |
          sudo apt-get update
          sudo apt-get install -y jq rsync
          mkdir -p ~/.openclaw/backups

      - name: Test unbound variable fix
        run: |
          # Create backup with unknown labels to trigger unbound variable issue
          TMP_DIR=$(mktemp -d)
          mkdir -p "$TMP_DIR/config" "$TMP_DIR/skills" "$TMP_DIR/extensions"
          echo '{}' > "$TMP_DIR/config/test.json"
          tar -czf "$HOME/.openclaw/backups/test-unbound.tar.gz" -C "$TMP_DIR" config skills extensions
          rm -rf "$TMP_DIR"
          
          # This should NOT fail with "unbound variable" error - call load_config
          bash -c 'source bin/lib/utils.sh; source bin/lib/config.sh; source bin/lib/restore.sh; load_config; set -euo pipefail; restore_backup "test-unbound.tar.gz" "" "--force"' || { echo "Unbound variable test failed"; exit 1; }
          
          echo "✅ Unbound variable test passed"

  shellcheck:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run shellcheck
        uses: ludeeus/action-shellcheck@master
        with:
          severity: error
          scandir: './bin'
